- defaults:
    name: frdeso_baremetal_benchmarks
    description: |
      Runs baremetal kernel tests over different combination of kernel and lttng configurations.
    triggers:
      - timed: "@hourly"
    logrotate:
      numToKeep: 10

    properties:
      - throttle:
          max-total: 2
          option: 'category'
          categories:
            - 'baremetal-tests'
    project-type: freestyle
    node: 'x86-64'

    publishers:
      - archive:
          artifacts: '*.png,*.csv'
          stable: true
          do-not-fingerprint: true
      - email:
          recipients: 'francis.deslauriers@efficios.com'
      - image-gallery:
        - gallery-type: archived-images-gallery
          title: Results
          includes: '*.png'
      - workspace-cleanup
    scm:
      - git:
          url: git://git-mirror.internal.efficios.com/lttng/lttng-tools.git
          branches:
            - "v2.8.1"
          shallow-clone: true
          skip-tag: true
          fastpoll: true
          basedir: src/lttng-tools
      - git:
          url: git://git-mirror.internal.efficios.com/lttng/lttng-modules.git
          branches:
            - "v2.8.1"
          shallow-clone: true
          skip-tag: true
          fastpoll: true
          basedir: src/lttng-modules
      - git:
          url: git://git-mirror.internal.efficios.com/kernel/stable/linux-stable.git
          branches:
            - "v4.4.9"
          shallow-clone: true
          skip-tag: true
          fastpoll: true
          basedir: src/linux

    builders:
      - shell: !include-raw: scripts/lttng-baremetal-tests/generate-properties-master.sh
      - shell: !include-raw: scripts/lttng-baremetal-tests/inject-ssh-commands.sh
      - trigger-builds:
        - project: "frdeso_build_kernel_PARAM_debug"
          property-file: 'properties.txt'
          block: true
      - inject:
          properties-file: properties.txt
      - shell: !include-raw: scripts/lttng-baremetal-tests/run-baremetal-benchmarks.sh
      - shell: !include-raw: scripts/lttng-baremetal-tests/summarize-results.sh


- job:
    name: frdeso_baremetal_benchmarks_kv4.4.9_lv2.8.1_debug_no1
    defaults: frdeso_baremetal_benchmarks
    wrappers:
      - workspace-cleanup
      - timestamps
      - ansicolor
      - credentials-binding:
          - text:
              credential-id: jenkins_lava_key
              variable: LAVA_JENKINS_TOKEN
          - file:
              credential-id: system_tests_storage_key
              variable: identity_file
      - inject:
          properties-content: |
            TOOLS_BRANCH=v2.8.1
            UST_BRANCH=v2.8.1
            BUILD_DEVICE=baremetal
            DEBUG_STRING=echo BONJOURALLO
- job:
    name: frdeso_baremetal_benchmarks_kv4.4.9_lv2.8.1_debug_no2
    defaults: frdeso_baremetal_benchmarks
    wrappers:
      - workspace-cleanup
      - timestamps
      - ansicolor
      - credentials-binding:
          - text:
              credential-id: jenkins_lava_key
              variable: LAVA_JENKINS_TOKEN
          - file:
              credential-id: system_tests_storage_key
              variable: identity_file
      - inject:
          properties-content: |
            TOOLS_BRANCH=v2.8.1
            UST_BRANCH=v2.8.1
            BUILD_DEVICE=baremetal
            DEBUG_STRING=sed -i \'1017iprintk(KERN_INFO\ \"ALLO\");\' fs/open.c
- job:
    name: frdeso_baremetal_benchmarks_kv4.4.9_lv2.8.1_debug_no3
    defaults: frdeso_baremetal_benchmarks
    wrappers:
      - workspace-cleanup
      - timestamps
      - ansicolor
      - credentials-binding:
          - text:
              credential-id: jenkins_lava_key
              variable: LAVA_JENKINS_TOKEN
          - file:
              credential-id: system_tests_storage_key
              variable: identity_file
      - inject:
          properties-content: |
            TOOLS_BRANCH=v2.8.1
            UST_BRANCH=v2.8.1
            BUILD_DEVICE=baremetal
          script-content: |
            sed -i \'1017iprintk(KERN_INFO\ \"bonjour\");\' fs/open.c
- job:
    name: frdeso_baremetal_benchmarks_kv4.4.9_lv2.8.1_debug_no4
    defaults: frdeso_baremetal_benchmarks
    wrappers:
      - workspace-cleanup
      - timestamps
      - ansicolor
      - credentials-binding:
          - text:
              credential-id: jenkins_lava_key
              variable: LAVA_JENKINS_TOKEN
          - file:
              credential-id: system_tests_storage_key
              variable: identity_file
      - inject:
          properties-content: |
            TOOLS_BRANCH=v2.8.1
            UST_BRANCH=v2.8.1
            BUILD_DEVICE=baremetal
            DEBUG_STRING=sed -i \'1017iif(strcmp(get_task_comm(nom,current),"frdeso_debug")==0){return\ ERR_PTR(-ENOENT);}\' fs/open.c
- job:
    name: frdeso_baremetal_benchmarks_kv4.4.9_lv2.8.1_debug_no5
    defaults: frdeso_baremetal_benchmarks
    wrappers:
      - workspace-cleanup
      - timestamps
      - ansicolor
      - credentials-binding:
          - text:
              credential-id: jenkins_lava_key
              variable: LAVA_JENKINS_TOKEN
          - file:
              credential-id: system_tests_storage_key
              variable: identity_file
      - inject:
          properties-content: |
            TOOLS_BRANCH=v2.8.1
            UST_BRANCH=v2.8.1
            BUILD_DEVICE=baremetal
            DEBUG_STRING=sed -i \'1019iif(strcmp(get_task_comm(nom,current),"frdeso_debug")==0){putname(tmp);return\ ERR_PTR(-ENOENT);}\' fs/open.c
- job:
    name: frdeso_baremetal_benchmarks_kv4.4.9_lv2.8.1_debug_no6
    defaults: frdeso_baremetal_benchmarks
    wrappers:
      - workspace-cleanup
      - timestamps
      - ansicolor
      - credentials-binding:
          - text:
              credential-id: jenkins_lava_key
              variable: LAVA_JENKINS_TOKEN
          - file:
              credential-id: system_tests_storage_key
              variable: identity_file
      - inject:
          properties-content: |
            TOOLS_BRANCH=v2.8.1
            UST_BRANCH=v2.8.1
            BUILD_DEVICE=baremetal
            DEBUG_STRING=sed -i \'1023iif(strcmp(get_task_comm(nom,current),"frdeso_debug")==0){putname(tmp);return\ ERR_PTR(-ENOENT);}\' fs/open.c
- job:
    name: frdeso_baremetal_benchmarks_kv4.4.9_lv2.8.1_debug_no7
    defaults: frdeso_baremetal_benchmarks
    wrappers:
      - workspace-cleanup
      - timestamps
      - ansicolor
      - credentials-binding:
          - text:
              credential-id: jenkins_lava_key
              variable: LAVA_JENKINS_TOKEN
          - file:
              credential-id: system_tests_storage_key
              variable: identity_file
      - inject:
          properties-content: |
            TOOLS_BRANCH=v2.8.1
            UST_BRANCH=v2.8.1
            BUILD_DEVICE=baremetal
            DEBUG_STRING=sed -i \'1033iif(strcmp(get_task_comm(nom,current),"frdeso_debug")==0){putname(tmp);return\ ERR_PTR(-ENOENT);}\' fs/open.c

- job:
    name: frdeso_baremetal_benchmarks_kv4.4.9_lv2.8.1_debug_no8
    defaults: frdeso_baremetal_benchmarks
    wrappers:
      - workspace-cleanup
      - timestamps
      - ansicolor
      - credentials-binding:
          - text:
              credential-id: jenkins_lava_key
              variable: LAVA_JENKINS_TOKEN
          - file:
              credential-id: system_tests_storage_key
              variable: identity_file
      - inject:
          properties-content: |
            TOOLS_BRANCH=v2.8.1
            UST_BRANCH=v2.8.1
            BUILD_DEVICE=baremetal
            DEBUG_STRING=sed -i \'1025iif(strcmp(get_task_comm(nom,current),"frdeso_debug")==0){putname(tmp);return\ ERR_PTR(-ENOENT);}\' fs/open.c
- job:
    name: frdeso_baremetal_benchmarks_kv4.4.9_lv2.8.1_debug_no9
    defaults: frdeso_baremetal_benchmarks
    wrappers:
      - workspace-cleanup
      - timestamps
      - ansicolor
      - credentials-binding:
          - text:
              credential-id: jenkins_lava_key
              variable: LAVA_JENKINS_TOKEN
          - file:
              credential-id: system_tests_storage_key
              variable: identity_file
      - inject:
          properties-content: |
            TOOLS_BRANCH=v2.8.1
            UST_BRANCH=v2.8.1
            BUILD_DEVICE=baremetal
            DEBUG_STRING=sed -i \'1027iif(strcmp(get_task_comm(nom,current),"frdeso_debug")==0){putname(tmp);return\ ERR_PTR(-ENOENT);}\' fs/open.c
- job:
    name: frdeso_baremetal_benchmarks_kv4.4.9_lv2.8.1_debug_fs_namei_3367
    defaults: frdeso_baremetal_benchmarks
    wrappers:
      - workspace-cleanup
      - timestamps
      - ansicolor
      - credentials-binding:
          - text:
              credential-id: jenkins_lava_key
              variable: LAVA_JENKINS_TOKEN
          - file:
              credential-id: system_tests_storage_key
              variable: identity_file
      - inject:
          properties-content: |
            TOOLS_BRANCH=v2.8.1
            UST_BRANCH=v2.8.1
            BUILD_DEVICE=baremetal
            DEBUG_STRING=sed -i \'3367iif(strcmp(get_task_comm(nom,current),"frdeso_debug")==0){return\ ERR_PTR(-ENOENT);}\' fs/namei.c
- job:
    name: frdeso_baremetal_benchmarks_kv4.4.9_lv2.8.1_debug_fs_namei_3368
    defaults: frdeso_baremetal_benchmarks
    wrappers:
      - workspace-cleanup
      - timestamps
      - ansicolor
      - credentials-binding:
          - text:
              credential-id: jenkins_lava_key
              variable: LAVA_JENKINS_TOKEN
          - file:
              credential-id: system_tests_storage_key
              variable: identity_file
      - inject:
          properties-content: |
            TOOLS_BRANCH=v2.8.1
            UST_BRANCH=v2.8.1
            BUILD_DEVICE=baremetal
            DEBUG_STRING=sed -i \'3368iif(strcmp(get_task_comm(nom,current),"frdeso_debug")==0){return\ ERR_PTR(-ENOENT);}\' fs/namei.c
- job:
    name: frdeso_baremetal_benchmarks_kv4.4.9_lv2.8.1_debug_fs_namei_3370
    defaults: frdeso_baremetal_benchmarks
    wrappers:
      - workspace-cleanup
      - timestamps
      - ansicolor
      - credentials-binding:
          - text:
              credential-id: jenkins_lava_key
              variable: LAVA_JENKINS_TOKEN
          - file:
              credential-id: system_tests_storage_key
              variable: identity_file
      - inject:
          properties-content: |
            TOOLS_BRANCH=v2.8.1
            UST_BRANCH=v2.8.1
            BUILD_DEVICE=baremetal
            DEBUG_STRING=sed -i \'3370iif(strcmp(get_task_comm(nom,current),"frdeso_debug")==0){return\ ERR_PTR(-ENOENT);}\' fs/namei.c
- job:
    name: frdeso_baremetal_benchmarks_kv4.4.9_lv2.8.1_debug_fs_namei_3372
    defaults: frdeso_baremetal_benchmarks
    wrappers:
      - workspace-cleanup
      - timestamps
      - ansicolor
      - credentials-binding:
          - text:
              credential-id: jenkins_lava_key
              variable: LAVA_JENKINS_TOKEN
          - file:
              credential-id: system_tests_storage_key
              variable: identity_file
      - inject:
          properties-content: |
            TOOLS_BRANCH=v2.8.1
            UST_BRANCH=v2.8.1
            BUILD_DEVICE=baremetal
            DEBUG_STRING=sed -i \'3372iif(strcmp(get_task_comm(nom,current),"frdeso_debug")==0){return\ ERR_PTR(-ENOENT);}\' fs/namei.c
- job:
    name: frdeso_baremetal_benchmarks_kv4.4.9_lv2.8.1_debug_fs_namei_3373
    defaults: frdeso_baremetal_benchmarks
    wrappers:
      - workspace-cleanup
      - timestamps
      - ansicolor
      - credentials-binding:
          - text:
              credential-id: jenkins_lava_key
              variable: LAVA_JENKINS_TOKEN
          - file:
              credential-id: system_tests_storage_key
              variable: identity_file
      - inject:
          properties-content: |
            TOOLS_BRANCH=v2.8.1
            UST_BRANCH=v2.8.1
            BUILD_DEVICE=baremetal
            DEBUG_STRING=sed -i \'3373iif(strcmp(get_task_comm(nom,current),"frdeso_debug")==0){return\ ERR_PTR(-ENOENT);}\' fs/namei.c
- job:
    name: frdeso_baremetal_benchmarks_kv4.4.9_lv2.8.1_debug_fs_namei_3316
    defaults: frdeso_baremetal_benchmarks
    wrappers:
      - workspace-cleanup
      - timestamps
      - ansicolor
      - credentials-binding:
          - text:
              credential-id: jenkins_lava_key
              variable: LAVA_JENKINS_TOKEN
          - file:
              credential-id: system_tests_storage_key
              variable: identity_file
      - inject:
          properties-content: |
            TOOLS_BRANCH=v2.8.1
            UST_BRANCH=v2.8.1
            BUILD_DEVICE=baremetal
            DEBUG_STRING=sed -i \'3316iif(strcmp(get_task_comm(nom,current),"frdeso_debug")==0){return\ ERR_PTR(-ENOENT);}\' fs/namei.c
- job:
    name: frdeso_baremetal_benchmarks_kv4.4.9_lv2.8.1_debug_fs_namei_3327
    defaults: frdeso_baremetal_benchmarks
    wrappers:
      - workspace-cleanup
      - timestamps
      - ansicolor
      - credentials-binding:
          - text:
              credential-id: jenkins_lava_key
              variable: LAVA_JENKINS_TOKEN
          - file:
              credential-id: system_tests_storage_key
              variable: identity_file
      - inject:
          properties-content: |
            TOOLS_BRANCH=v2.8.1
            UST_BRANCH=v2.8.1
            BUILD_DEVICE=baremetal
            DEBUG_STRING=sed -i \'3327iif(strcmp(get_task_comm(nom,current),"frdeso_debug")==0){return\ ERR_PTR(-ENOENT);}\' fs/namei.c
- job:
    name: frdeso_baremetal_benchmarks_kv4.4.9_lv2.8.1_debug_fs_namei_3328
    defaults: frdeso_baremetal_benchmarks
    wrappers:
      - workspace-cleanup
      - timestamps
      - ansicolor
      - credentials-binding:
          - text:
              credential-id: jenkins_lava_key
              variable: LAVA_JENKINS_TOKEN
          - file:
              credential-id: system_tests_storage_key
              variable: identity_file
      - inject:
          properties-content: |
            TOOLS_BRANCH=v2.8.1
            UST_BRANCH=v2.8.1
            BUILD_DEVICE=baremetal
            DEBUG_STRING=sed -i \'3328iif(strcmp(get_task_comm(nom,current),"frdeso_debug")==0){return\ ERR_PTR(-ENOENT);}\' fs/namei.c
- job:
    name: frdeso_baremetal_benchmarks_kv4.4.9_lv2.8.1_debug_fs_namei_3342
    defaults: frdeso_baremetal_benchmarks
    wrappers:
      - workspace-cleanup
      - timestamps
      - ansicolor
      - credentials-binding:
          - text:
              credential-id: jenkins_lava_key
              variable: LAVA_JENKINS_TOKEN
          - file:
              credential-id: system_tests_storage_key
              variable: identity_file
      - inject:
          properties-content: |
            TOOLS_BRANCH=v2.8.1
            UST_BRANCH=v2.8.1
            BUILD_DEVICE=baremetal
            DEBUG_STRING=sed -i \'3342iif(strcmp(get_task_comm(nom,current),"frdeso_debug")==0){return\ ERR_PTR(-ENOENT);}\' fs/namei.c
- job:
    name: frdeso_baremetal_benchmarks_kv4.4.9_lv2.8.1_debug_fs_namei_1543_print
    defaults: frdeso_baremetal_benchmarks
    wrappers:
      - workspace-cleanup
      - timestamps
      - ansicolor
      - credentials-binding:
          - text:
              credential-id: jenkins_lava_key
              variable: LAVA_JENKINS_TOKEN
          - file:
              credential-id: system_tests_storage_key
              variable: identity_file
      - inject:
          properties-content: |
            TOOLS_BRANCH=v2.8.1
            UST_BRANCH=v2.8.1
            BUILD_DEVICE=baremetal
            DEBUG_STRING=sed -i \'1543iif(strcmp(get_task_comm(nom,current),"frdeso_debug")==0){printk(KERN_INFO\ \"flags:0x%x\",flags|LOOKUP_RCU);}\' fs/namei.c

#---------------- end debug-----------------------
- job:
    name: frdeso_build_kernel_PARAM_debug
    description: |
      Builds a Linux Kernel and LTTng Modules if necessary
    defaults: global
    concurrent: true

    logrotate:
      numToKeep: 50
    node: 'x86-64'

    wrappers:
      - workspace-cleanup
      - timestamps
      - ansicolor
      - credentials-binding:
          - file:
              credential-id: system_tests_storage_key
              variable: identity_file
    builders:
      - shell: !include-raw: scripts/lttng-baremetal-tests/generate-properties-slave.sh
      - inject:
          properties-file: properties.txt
      - shell: !include-raw: scripts/lttng-baremetal-tests/check-build-needs.sh
      - conditional-step:
          condition-kind: not
          condition-operand:
              condition-kind: file-exists
              condition-filename: kernel-built.txt
              condition-basedir: workspace
          steps:
              - shell: !include-raw: scripts/lttng-baremetal-tests/build-kernel.sh
      - conditional-step:
          condition-kind: not
          condition-operand:
              condition-kind: file-exists
              condition-filename: modules-built.txt
              condition-basedir: workspace
          steps:
              - shell: !include-raw: scripts/lttng-baremetal-tests/build-modules.sh

    parameters:
      - string:
          name: 'LTTNG_MODULES_COMMIT_ID'
          description: 'The lttng-modules commmit to build.'
      - string:
          name: 'KERNEL_COMMIT_ID'
          description: 'The kernel commit to build.'
      - string:
          name: 'KGITREPO'
          description: 'The kernel git repo to fetch from'
      - string:
          name: 'BASE_STORAGE_FOLDER'
          description: 'Path to store the run data'
      - string:
          name: 'STORAGE_KERNEL_FOLDER'
          description: 'Path to store the Kernel image'
      - string:
          name: 'STORAGE_KERNEL_IMAGE'
          description: 'Path to store the Kernel IMAGE'
      - string:
          name: 'STORAGE_LINUX_MODULES'
          description: 'Path to store the Kernel Modules'
      - string:
          name: 'STORAGE_LTTNG_MODULES'
          description: 'Path to store the LTTng Modules'
      - string:
          name: 'BUILD_DEVICE'
          description: 'The target device. (kvm or baremetal)'
      - string:
          name: 'DEBUG_STRING'
          default: 'ls'
          description: 'debug string'
    publishers:
      - workspace-cleanup
